<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">

<title>sap.ui.table - Personalization with TablePersoController</title>
<script src="shared-config.js"></script>
<script id="sap-ui-bootstrap"
		src="../../../../resources/sap-ui-core.js"
		data-sap-ui-libs="sap.m,sap.ui.table">
</script>

<style type="text/css">

	#table-content {
		margin-top: 10px;
	}

	#header {
		margin-left: 6px;
	}

	#perso-data {
		margin: 10px;
	}

	.dataMargin {
		margin-left: 10px;
	}

</style>

<script>
	sap.ui.require([
		"sap/ui/table/Table",
		"sap/ui/table/Column",
		"sap/ui/table/TablePersoController",
		"sap/m/Toolbar",
		"sap/m/Button",
		"sap/m/ToggleButton",
		"sap/m/Label",
		"sap/m/MessageBox",
		"sap/ui/core/CustomData",
		"sap/ui/model/json/JSONModel"
	], function(Table, Column, TablePersoController, Toolbar, Button, ToggleButton, Label, MessageBox, CustomData, JSONModel) {

		const oData = {
			items: [
				{name: "Michelle", color: "orange", number: 3.14},
				{name: "Joseph", color: "blue", number: 1.618},
				{name: "David", color: "green", number: 0}
			],
			cols: ["Name", "Color", "Number"]
		};

		//make sure table id suffix is set (this is necessary for personalization)
		const oTable = new Table({
			/**
			 * @deprecated As of Version 1.117
			 */
			showColumnVisibilityMenu: true,
			extension: [
				new Toolbar({
					content: [
						new Button({
							text: "Clear and Refresh",
							icon: "sap-icon://refresh",
							press: function(oEvent) {
								oPersoService.delPersData();
								oTPC.refresh().done(function() {
									MessageBox.information("Done!", {title: "Refresh"});
								});
							}
						}),
						new Button({
							text: "Save",
							icon: "sap-icon://save",
							press: function(oEvent) {
								oTPC.savePersonalizations().done(function() {
									MessageBox.information("Done!", {title: "Save"});
								});
							}
						}),
						new ToggleButton({
							text: "AutoSave",
							icon: "sap-icon://save",
							pressed: true,
							press: function(oEvent) {
								oTPC.setAutoSave(this.getPressed());
							}
						})
					]
				})
			],
			columns: jQuery.map(oData.cols, function(sColumn) {
				return new Column({
					label: new Label({text: sColumn}),
					visible: sColumn === "Color" ? false : true, // Color column should be invisible by default
					template: new Label({
						text: {
							path: sColumn.toLowerCase()
						}
					}),
					customData: [
						new CustomData({ // PersoService: customDataKey
							key: "persoKey",
							value: sColumn
						})
					],
					sortProperty: sColumn.toLowerCase(),
					filterProperty: sColumn.toLowerCase()
				});
			}),
			customData: [
				new CustomData({ // PersoService: customDataKey
					key: "persoKey",
					value: "PersoTable"
				})
			]
		});

		oTable.setModel(new JSONModel(oData));
		oTable.bindRows("/items");

		const printPersoData = function(sJSON) {
			jQuery("#perso-data").html(sJSON
					.replace(/\n/g, "<br>")
					.replace(/\s/g, "&nbsp;")
					.replace(/(true)/g, "<span style=\"color:green\">$1</span>")
					.replace(/(false)/g, "<span style=\"color:red\">$1</span>"));
		};

		const oPersoService = {

			getPersData: function() {
				const oDeferred = jQuery.Deferred();
				const sJSON = window.localStorage.getItem("myTablePersonalization") || "{}";
				printPersoData(sJSON);
				const oBundle = JSON.parse(sJSON);
				oDeferred.resolve(oBundle);
				return oDeferred.promise();
			},

			setPersData: function(oBundle) {
				const oDeferred = jQuery.Deferred();
				const sJSON = JSON.stringify(oBundle, null, 4);
				window.localStorage.setItem("myTablePersonalization", sJSON);
				printPersoData(sJSON);
				oDeferred.resolve();
				return oDeferred.promise();
			},

			delPersData: function() {
				const oDeferred = jQuery.Deferred();
				window.localStorage.removeItem("myTablePersonalization");
				printPersoData("");
				oDeferred.resolve();
				return oDeferred.promise();
			}
		};

		const oTPC = new TablePersoController({
			table: oTable,
			persoService: oPersoService
		});

		oTable.placeAt("table-content");

	});
</script>
</head>
<body id="body" class="sapUiBody">
<h1 id="header">Test Page for <code>sap.ui.table.TablePersoController</code></h1>
<div id="table-content"></div>
<p class="dataMargin">Local Storage Data</p>
<div id="perso-data"></div>
</body>
</html>
